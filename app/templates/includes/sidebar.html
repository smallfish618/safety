<!-- 修改侧边栏模板，确保有效期预警菜单项正确显示 -->

<div class="sidebar">
    <div class="sidebar-brand">
        <a href="{{ url_for('station.index') }}" class="text-decoration-none text-white">
            <i class="bi bi-fire me-2"></i>消防安全管理系统
        </a>
    </div>
    
    <ul class="nav flex-column">
        <li class="nav-item">
            <a href="{{ url_for('station.index') }}" class="nav-link {% if request.endpoint == 'station.index' %}active{% endif %}">
                <i class="bi bi-building me-2"></i>
                <span>微型消防站</span>
            </a>
        </li>
        
        <li class="nav-item">
            <a href="{{ url_for('equipment.index') }}" class="nav-link {% if 'equipment.' in request.endpoint %}active{% endif %}">
                <i class="bi bi-tools me-2"></i>
                <span>消防器材</span>
            </a>
        </li>
        
        <!-- 修改有效期预警菜单项，确保正确检查权限并始终显示 -->
        <li class="nav-item">
            <a href="{{ url_for('admin.expiry_alert') }}" 
               class="nav-link {% if request.endpoint == 'admin.expiry_alert' %}active{% endif %} 
                          {% if not can_view_expiry_alert %}text-muted opacity-50{% endif %}"
               {% if not can_view_expiry_alert %}onclick="showNoPermissionAlert(event, '有效期预警')"{% endif %}>
                <i class="bi bi-clock-history me-2"></i>
                <span>有效期预警</span>
                {% if not can_view_expiry_alert %}
                    <i class="bi bi-lock-fill ms-1 text-danger small"></i>
                {% endif %}
            </a>
        </li>
        
        {% if current_user.role == 'admin' %}
        <!-- 管理员菜单 -->
        <li class="nav-item">
            <a href="{{ url_for('admin.users') }}" class="nav-link {% if request.endpoint == 'admin.users' %}active{% endif %}">
                <i class="bi bi-people me-2"></i>
                <span>用户管理</span>
            </a>
        </li>
        
        <li class="nav-item">
            <a href="{{ url_for('admin.expiry') }}" class="nav-link {% if request.endpoint == 'admin.expiry' %}active{% endif %}">
                <i class="bi bi-calendar-check me-2"></i>
                <span>有效期规则</span>
            </a>
        </li>
        
        <li class="nav-item">
            <a href="{{ url_for('admin.responsible') }}" class="nav-link {% if request.endpoint == 'admin.responsible' %}active{% endif %}">
                <i class="bi bi-person-badge me-2"></i>
                <span>负责人管理</span>
            </a>
        </li>
        {% endif %}
        
        <!-- 个人信息和退出 -->
        <li class="nav-item mt-3">
            <a href="{{ url_for('auth.my_account') }}" class="nav-link {% if request.endpoint == 'auth.my_account' %}active{% endif %}">
                <i class="bi bi-person-circle me-2"></i>
                <span>个人信息</span>
            </a>
        </li>
        
        <li class="nav-item">
            <a href="{{ url_for('auth.logout') }}" class="nav-link">
                <i class="bi bi-box-arrow-right me-2"></i>
                <span>退出登录</span>
            </a>
        </li>
    </ul>
    
    <!-- 调试信息 - 仅在开发环境显示 -->
    {% if config.DEBUG %}
    <div class="mt-5 p-3 text-white bg-dark opacity-75 d-none">
        <h6>权限调试信息:</h6>
        <hr>
        <p class="mb-1"><small>用户: {{ current_user.username }}</small></p>
        <p class="mb-1"><small>角色: {{ current_user.role }}</small></p>
        <p class="mb-1"><small>预警权限: {{ can_view_expiry_alert }}</small></p>
    </div>
    {% endif %}
</div>

<!-- 添加JavaScript处理无权限提示 -->
<script>
function showNoPermissionAlert(e, module) {
    e.preventDefault();
    alert(`您没有访问"${module}"的权限，请联系管理员获取相应权限。`);
}

// 在页面加载时执行一次检查，输出权限信息
document.addEventListener('DOMContentLoaded', function() {
    console.log("预警权限状态: ", {{ can_view_expiry_alert|tojson }});
    console.log("用户角色: ", "{{ current_user.role }}");
    
    {% if current_user.role != 'admin' %}
    // 非管理员用户，检查其微型站和器材权限
    console.log("微型站权限: ", {{ user_permissions_by_type.micro_station|tojson }});
    console.log("消防器材权限: ", {{ user_permissions_by_type.fire_equipment|tojson }});
    {% endif %}
});
</script>

<!-- 创建无权限提示页面 -->
