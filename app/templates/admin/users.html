{% extends 'base.html' %}

{% block title %}用户管理 - 消防安全管理系统{% endblock %}

{% block styles %}
<style>
    .permissions-container {
        max-height: 500px;
        overflow-y: auto;
    }
    
    .permission-card {
        margin-bottom: 15px;
        border-left: 4px solid #6c757d;
    }
    
    .permission-card.type-1 {
        border-left-color: #007bff;
    }
    
    .permission-card.type-2 {
        border-left-color: #28a745;
    }
    
    .permission-card.type-3 {
        border-left-color: #fd7e14;
    }
    
    .permission-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    
    .permission-badges {
        margin-top: 5px;
    }
    
    .permission-badges .badge {
        margin-right: 5px;
    }
    
    /* 权限类型标签样式 */
    .type-label-1 {
        background-color: #007bff;
        color: white;
    }
    
    .type-label-2 {
        background-color: #28a745;
        color: white;
    }
    
    .type-label-3 {
        background-color: #fd7e14;
        color: white;
    }
    
    /* 表格样式 */
    .table-hover tbody tr:hover {
        background-color: rgba(0, 123, 255, 0.1);
        cursor: pointer;
    }
    
    .selected-user {
        background-color: rgba(0, 123, 255, 0.15) !important;
        font-weight: bold;
    }
    
    /* 权限勾选样式 */
    .permission-checkbox {
        display: inline-block;
        margin-right: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <h2 class="mb-4">用户管理</h2>
    
    <div class="row">
        <!-- 用户列表部分 -->
        <div class="col-md-4">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>用户列表</span>
                    <button class="btn btn-primary btn-sm" data-bs-toggle="modal" data-bs-target="#addUserModal">
                        <i class="bi bi-person-plus"></i> 添加用户
                    </button>
                </div>
                <div class="card-body">
                    {% if users %}
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>用户名</th>
                                    <th>角色</th>
                                    <th>状态</th>
                                    <th>操作</th> <!-- 添加操作列 -->
                                </tr>
                            </thead>
                            <tbody>
                                {% for user in users %}
                                <tr data-user-id="{{ user.id }}" class="user-row {% if selected_user_id == user.id %}selected-user{% endif %}">
                                    <td>{{ user.id }}</td>
                                    <td>{{ user.username }}</td>
                                    <td>
                                        <span class="badge {% if user.role == 'admin' %}bg-danger{% else %}bg-primary{% endif %}">
                                            {{ '管理员' if user.role == 'admin' else '普通用户' }}
                                        </span>
                                    </td>
                                    <td>
                                        <span class="badge {% if user.is_active %}bg-success{% else %}bg-secondary{% endif %}">
                                            {{ '启用' if user.is_active else '禁用' }}
                                        </span>
                                    </td>
                                    <td>
                                        <div class="btn-group btn-group-sm">
                                            <button class="btn btn-sm btn-info edit-user-btn" 
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#editUserModal"
                                                    data-user-id="{{ user.id }}"
                                                    data-username="{{ user.username }}"
                                                    data-email="{{ user.email|default('') }}"
                                                    data-role="{{ user.role }}"
                                                    data-active="{{ user.is_active }}">
                                                <i class="bi bi-pencil"></i>
                                            </button>
                                            <form method="POST" action="{{ url_for('admin.toggle_user', user_id=user.id) }}">
                                                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                                                <button type="submit" class="btn btn-sm btn-{{ 'warning' if user.is_active else 'success' }}" title="{{ '禁用账户' if user.is_active else '启用账户' }}">
                                                    <i class="bi bi-{{ 'lock-fill' if user.is_active else 'unlock-fill' }}"></i>
                                                </button>
                                            </form>
                                            <button class="btn btn-sm btn-secondary reset-pwd-btn"
                                                    data-bs-toggle="modal" 
                                                    data-bs-target="#resetPasswordModal"
                                                    data-user-id="{{ user.id }}"
                                                    data-username="{{ user.username }}">
                                                <i class="bi bi-key"></i>
                                            </button>
                                        </div>
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="alert alert-info">暂无用户数据</div>
                    {% endif %}
                </div>
            </div>
        </div>
        
        <!-- 用户权限管理部分 -->
        <div class="col-md-8">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <div>
                        <span>权限管理</span>
                        <span id="current-user-name" class="ms-2 badge bg-primary"></span>
                    </div>
                    <button id="add-permission-btn" class="btn btn-success btn-sm" data-bs-toggle="modal" data-bs-target="#addPermissionModal" disabled>
                        <i class="bi bi-plus-circle"></i> 添加权限
                    </button>
                </div>
                <div class="card-body">
                    <div id="permissions-placeholder" class="alert alert-info">
                        请从左侧选择用户以管理权限
                    </div>
                    
                    <div id="permissions-container" class="permissions-container d-none">
                        <!-- 权限卡片将通过AJAX加载 -->
                    </div>
                    
                    <div id="no-permissions" class="alert alert-warning d-none">
                        该用户暂无任何权限设置
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- 添加用户模态框 -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="addUserModalLabel">添加用户</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <form method="POST" action="{{ url_for('admin.add_user') }}" id="addUserForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="username" class="form-label">用户名 <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="username" name="username" required>
                    </div>
                    <div class="mb-3">
                        <label for="password" class="form-label">密码 <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="password" name="password" required>
                    </div>
                    <div class="mb-3">
                        <label for="confirm_password" class="form-label">确认密码 <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="confirm_password" name="confirm_password" required>
                    </div>
                    <div class="mb-3">
                        <label for="role" class="form-label">角色</label>
                        <select class="form-select" id="role" name="role">
                            <option value="user">普通用户</option>
                            <option value="admin">管理员</option>
                        </select>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="is_active" name="is_active" checked>
                        <label class="form-check-label" for="is_active">
                            账号启用
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">保存</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 修改添加权限模态框 - 支持针对不同用户角色显示不同内容 -->
<div class="modal fade" id="addPermissionModal" tabindex="-1" aria-labelledby="addPermissionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5 class="modal-title" id="addPermissionModalLabel">添加权限</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            
            <!-- 管理员提示信息区域 -->
            <div id="admin-permission-notice" class="d-none">
                <div class="modal-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        <strong>提示：</strong> 该用户已经是管理员，拥有所有操作类型、所有区域的所有权限，无需添加！
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
                </div>
            </div>
            
            <!-- 普通用户添加权限表单区域 -->
            <form method="POST" action="{{ url_for('admin.add_permission') }}" id="addPermissionForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="user_id" id="permission_user_id" value="">
                
                <div id="normal-permission-form" class="d-none">
                    <div class="modal-body">
                        <div class="mb-3">
                            <label for="operation_type" class="form-label">操作类型 <span class="text-danger">*</span></label>
                            <select class="form-select" id="operation_type" name="operation_type" required>
                                <option value="">-- 请选择操作类型 --</option>
                                <option value="微型消防站">1 - 微型消防站</option>
                                <option value="灭火器和呼吸器">2 - 灭火器和呼吸器</option>
                                <option value="应急灯具" disabled>3 - 应急灯具（暂未开放）</option>
                            </select>
                        </div>
                        
                        <div class="mb-3">
                            <label for="area_id" class="form-label">操作区域 <span class="text-danger">*</span></label>
                            <select class="form-select" id="area_id" name="area_id" required disabled>
                                <option value="">-- 请先选择操作类型 --</option>
                            </select>
                            <small class="form-text text-muted">区域列表将根据选择的操作类型动态加载</small>
                            <!-- 添加隐藏的区域名称字段，通过JavaScript填充 -->
                            <input type="hidden" id="area_name" name="area_name" value="">
                        </div>
                        
                        <div class="mb-3">
                            <label class="form-label">权限设置 <span class="text-danger">*</span></label>
                            <div class="d-flex flex-wrap">
                                <div class="permission-checkbox">
                                    <input class="form-check-input" type="checkbox" id="can_view" name="can_view" checked>
                                    <label class="form-check-label" for="can_view">可查看</label>
                                </div>
                                <div class="permission-checkbox">
                                    <input class="form-check-input" type="checkbox" id="can_add" name="can_add">
                                    <label class="form-check-label" for="can_add">可新增</label>
                                </div>
                                <div class="permission-checkbox">
                                    <input class="form-check-input" type="checkbox" id="can_edit" name="can_edit">
                                    <label class="form-check-label" for="can_edit">可编辑</label>
                                </div>
                                <div class="permission-checkbox">
                                    <input class="form-check-input" type="checkbox" id="can_delete" name="can_delete">
                                    <label class="form-check-label" for="can_delete">可删除</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                        <button type="submit" class="btn btn-success">保存</button>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 编辑权限模态框 -->
<div class="modal fade" id="editPermissionModal" tabindex="-1" aria-labelledby="editPermissionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="editPermissionModalLabel">编辑权限</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <form method="POST" id="editPermissionForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="operation_type" id="edit_permission_operation_type" value="">
                <input type="hidden" name="area_id" id="edit_permission_area_id" value="">
                <input type="hidden" name="area_name" id="edit_permission_area_name" value="">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_operation_type" class="form-label">操作类型 <span class="text-danger">*</span></label>
                        <select class="form-select" id="edit_operation_type" name="operation_type" required disabled>
                            <option value="微型消防站">1 - 微型消防站</option>
                            <option value="灭火器和呼吸器">2 - 灭火器和呼吸器</option>
                            <option value="应急灯具">3 - 应急灯具</option>
                        </select>
                        <small class="form-text text-muted">操作类型和区域不可更改，如需修改请删除后重新添加</small>
                    </div>
                    
                    <div class="mb-3">
                        <label for="edit_area_id" class="form-label">操作区域 <span class="text-danger">*</span></label>
                        <select class="form-select" id="edit_area_id" name="area_id" required disabled>
                            <option value="">-- 请选择区域 --</option>
                            {% for area in areas %}
                            <option value="{{ area.area_code }}">{{ area.area_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="mb-3">
                        <label class="form-label">权限设置 <span class="text-danger">*</span></label>
                        <div class="d-flex flex-wrap">
                            <div class="permission-checkbox">
                                <input class="form-check-input" type="checkbox" id="edit_can_view" name="can_view">
                                <label class="form-check-label" for="edit_can_view">可查看</label>
                            </div>
                            <div class="permission-checkbox">
                                <input class="form-check-input" type="checkbox" id="edit_can_add" name="can_add">
                                <label class="form-check-label" for="edit_can_add">可新增</label>
                            </div>
                            <div class="permission-checkbox">
                                <input class="form-check-input" type="checkbox" id="edit_can_edit" name="can_edit">
                                <label class="form-check-label" for="edit_can_edit">可编辑</label>
                            </div>
                            <div class="permission-checkbox">
                                <input class="form-check-input" type="checkbox" id="edit_can_delete" name="can_delete">
                                <label class="form-check-label" for="edit_can_delete">可删除</label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-warning">保存修改</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 删除权限确认模态框 -->
<div class="modal fade" id="deletePermissionModal" tabindex="-1" aria-labelledby="deletePermissionModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="deletePermissionModalLabel">确认删除</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <p>您确定要删除此权限吗？此操作不可恢复。</p>
                <table class="table table-sm">
                    <tr>
                        <th width="30%">操作类型：</th>
                        <td id="delete_operation_type"></td>
                    </tr>
                    <tr>
                        <th>操作区域：</th>
                        <td id="delete_area_name"></td>
                    </tr>
                </table>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <form id="deletePermissionForm" method="POST">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <button type="submit" class="btn btn-danger">确认删除</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 用户状态切换确认模态框 -->
<div class="modal fade" id="toggleUserStatusModal" tabindex="-1" aria-labelledby="toggleUserStatusModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-warning text-white">
                <h5 class="modal-title" id="toggleUserStatusModalLabel">更改用户状态</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <div class="modal-body">
                <p id="toggle-status-message">确定要更改此用户的状态吗？</p>
                <div class="alert alert-info">
                    <strong>提示：</strong>禁用后用户将无法登录系统
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                <form id="toggleUserStatusForm" method="POST" action="{{ url_for('admin.toggle_user', user_id=0) }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                    <input type="hidden" name="user_id" id="toggle_user_id" value="">
                    <button type="submit" class="btn btn-warning" id="toggleUserStatusButton">确认更改</button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- 添加用户信息编辑模态框 -->
<div class="modal fade" id="editUserModal" tabindex="-1" aria-labelledby="editUserModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-info text-white">
                <h5 class="modal-title" id="editUserModalLabel">编辑用户信息</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <form method="POST" action="{{ url_for('admin.edit_user', user_id=0) }}" id="editUserForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="user_id" id="edit_user_id" value="">
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="edit_username" class="form-label">用户名</label>
                        <input type="text" class="form-control" id="edit_username" disabled>
                        <small class="form-text text-muted">用户名不可修改</small>
                    </div>
                    <div class="mb-3">
                        <label for="edit_email" class="form-label">邮箱地址</label>
                        <input type="email" class="form-control" id="edit_email" name="email">
                    </div>
                    <div class="mb-3">
                        <label for="edit_role" class="form-label">角色</label>
                        <select class="form-select" id="edit_role" name="role">
                            <option value="user">普通用户</option>
                            <option value="admin">管理员</option>
                        </select>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="edit_is_active" name="is_active">
                        <label class="form-check-label" for="edit_is_active">
                            账号启用
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">保存更改</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- 密码重置模态框 -->
<div class="modal fade" id="resetPasswordModal" tabindex="-1" aria-labelledby="resetPasswordModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-secondary text-white">
                <h5 class="modal-title" id="resetPasswordModalLabel">重置密码</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="关闭"></button>
            </div>
            <form method="POST" action="{{ url_for('admin.reset_password') }}" id="resetPasswordForm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" name="user_id" id="reset_user_id" value="">
                <div class="modal-body">
                    <p>重置用户 <strong id="reset_username"></strong> 的密码</p>
                    <div class="mb-3">
                        <label for="new_password" class="form-label">新密码 <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="new_password" name="new_password" required>
                    </div>
                    <div class="mb-3">
                        <label for="confirm_new_password" class="form-label">确认新密码 <span class="text-danger">*</span></label>
                        <input type="password" class="form-control" id="confirm_new_password" name="confirm_new_password" required>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">取消</button>
                    <button type="submit" class="btn btn-primary">重置密码</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
{{ super() }}
<script>
document.addEventListener('DOMContentLoaded', function() {
    let selectedUserId = null;
    let selectedUserRole = null;
    const permissionsContainer = document.getElementById('permissions-container');
    const permissionsPlaceholder = document.getElementById('permissions-placeholder');
    const noPermissions = document.getElementById('no-permissions');
    const currentUserName = document.getElementById('current-user-name');
    const addPermissionBtn = document.getElementById('add-permission-btn');
    
    // 点击用户行事件
    const userRows = document.querySelectorAll('.user-row');
    userRows.forEach(row => {
        row.addEventListener('click', function() {
            // 移除其他行的选中样式
            userRows.forEach(r => r.classList.remove('selected-user'));
            // 添加选中样式
            this.classList.add('selected-user');
            
            // 获取用户ID和用户名
            selectedUserId = this.getAttribute('data-user-id');
            const userName = this.querySelector('td:nth-child(2)').textContent;
            
            // 获取用户角色 - 添加这段代码
            const roleElement = this.querySelector('td:nth-child(3) .badge');
            selectedUserRole = roleElement ? 
                (roleElement.classList.contains('bg-danger') ? 'admin' : 'user') : 
                'user';
            
            // 更新当前选中的用户名显示
            currentUserName.textContent = userName;
            
            // 启用添加权限按钮
            addPermissionBtn.disabled = false;
            
            // 设置添加权限表单的用户ID
            document.getElementById('permission_user_id').value = selectedUserId;
            
            // 加载用户权限
            loadUserPermissions(selectedUserId);
        });
    });
    
    // 获取模态框相关元素
    const addPermissionModal = document.getElementById('addPermissionModal');
    const adminNotice = document.getElementById('admin-permission-notice');
    const normalForm = document.getElementById('normal-permission-form');
    
    // 监听模态框显示事件
    if (addPermissionModal) {
        addPermissionModal.addEventListener('show.bs.modal', function (event) {
            // 根据用户角色显示不同内容
            if (selectedUserRole === 'admin') {
                // 显示管理员提示
                adminNotice.classList.remove('d-none');
                normalForm.classList.add('d-none');
            } else {
                // 显示普通用户权限表单
                adminNotice.classList.add('d-none');
                normalForm.classList.remove('d-none');
            }
        });
    }
    
    // 加载用户权限函数
    function loadUserPermissions(userId) {
        // 显示加载中状态
        permissionsContainer.innerHTML = '<div class="text-center"><div class="spinner-border" role="status"><span class="visually-hidden">加载中...</span></div></div>';
        permissionsContainer.classList.remove('d-none');
        permissionsPlaceholder.classList.add('d-none');
        noPermissions.classList.add('d-none');
        
        // 发送AJAX请求获取权限数据
        fetch(`/admin/api/users/${userId}/permissions`)
            .then(response => response.json())
            .then(data => {
                if (data.success && data.permissions.length > 0) {
                    renderPermissions(data.permissions);
                } else {
                    // 显示无权限提示
                    permissionsContainer.classList.add('d-none');
                    noPermissions.classList.remove('d-none');
                }
            })
            .catch(error => {
                console.error('加载权限失败:', error);
                permissionsContainer.innerHTML = `<div class="alert alert-danger">加载权限数据失败: ${error.message}</div>`;
            });
    }
    
    // 渲染权限列表
    function renderPermissions(permissions) {
        permissionsContainer.innerHTML = '';
        
        permissions.forEach(permission => {
            // 权限类型标识
            let typeClass = '';
            let typeNum = '';
            
            if (permission.operation_type === '微型消防站') {
                typeClass = 'type-1';
                typeNum = '1';
            } else if (permission.operation_type === '灭火器和呼吸器') {
                typeClass = 'type-2';
                typeNum = '2';
            } else if (permission.operation_type === '应急灯具') {
                typeClass = 'type-3';
                typeNum = '3';
            }
            
            const permissionCard = document.createElement('div');
            permissionCard.className = `card permission-card ${typeClass}`;
            permissionCard.setAttribute('data-permission-id', permission.id);
            
            const permissionContent = `
                <div class="card-body">
                    <div class="permission-header">
                        <h5 class="card-title">
                            <span class="badge type-label-${typeNum}">${typeNum}</span>
                            ${permission.operation_type} - ${permission.area_name}
                        </h5>
                        <div>
                            <button class="btn btn-sm btn-outline-warning edit-permission-btn" 
                                    data-permission-id="${permission.id}"
                                    data-operation-type="${permission.operation_type}"
                                    data-area-id="${permission.area_id}"
                                    data-area-name="${permission.area_name}"
                                    data-can-view="${permission.can_view}"
                                    data-can-add="${permission.can_add}"
                                    data-can-edit="${permission.can_edit}"
                                    data-can-delete="${permission.can_delete}">
                                <i class="bi bi-pencil"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-danger delete-permission-btn"
                                    data-permission-id="${permission.id}"
                                    data-operation-type="${permission.operation_type}"
                                    data-area-name="${permission.area_name}">
                                <i class="bi bi-trash"></i>
                            </button>
                        </div>
                    </div>
                    <div class="permission-badges">
                        ${permission.can_view ? '<span class="badge bg-info">可查看</span>' : ''}
                        ${permission.can_add ? '<span class="badge bg-success">可新增</span>' : ''}
                        ${permission.can_edit ? '<span class="badge bg-warning">可编辑</span>' : ''}
                        ${permission.can_delete ? '<span class="badge bg-danger">可删除</span>' : ''}
                    </div>
                </div>
            `;
            
            permissionCard.innerHTML = permissionContent;
            permissionsContainer.appendChild(permissionCard);
        });
        
        // 添加编辑权限按钮点击事件
        document.querySelectorAll('.edit-permission-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const permissionId = this.getAttribute('data-permission-id');
                const operationType = this.getAttribute('data-operation-type');
                const areaId = this.getAttribute('data-area-id');
                const canView = this.getAttribute('data-can-view') === 'true';
                const canAdd = this.getAttribute('data-can-add') === 'true';
                const canEdit = this.getAttribute('data-can-edit') === 'true';
                const canDelete = this.getAttribute('data-can-delete') === 'true';
                
                // 设置表单值
                const form = document.getElementById('editPermissionForm');
                form.action = `/admin/edit_permission/${permissionId}`;
                
                document.getElementById('edit_operation_type').value = operationType;
                document.getElementById('edit_area_id').value = areaId;
                document.getElementById('edit_can_view').checked = canView;
                document.getElementById('edit_can_add').checked = canAdd;
                document.getElementById('edit_can_edit').checked = canEdit;
                document.getElementById('edit_can_delete').checked = canDelete;
                
                // 显示编辑模态框
                const modal = new bootstrap.Modal(document.getElementById('editPermissionModal'));
                modal.show();
            });
        });
        
        // 添加删除权限按钮点击事件
        document.querySelectorAll('.delete-permission-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const permissionId = this.getAttribute('data-permission-id');
                const operationType = this.getAttribute('data-operation-type');
                const areaName = this.getAttribute('data-area-name');
                
                // 设置删除表单
                const form = document.getElementById('deletePermissionForm');
                form.action = `/admin/delete_permission/${permissionId}`;
                
                // 设置确认信息
                document.getElementById('delete_operation_type').textContent = operationType;
                document.getElementById('delete_area_name').textContent = areaName;
                
                // 显示删除确认模态框
                const modal = new bootstrap.Modal(document.getElementById('deletePermissionModal'));
                modal.show();
            });
        });
    }
    
    // 添加用户表单验证
    const addUserForm = document.getElementById('addUserForm');
    if (addUserForm) {
        addUserForm.addEventListener('submit', function(e) {
            const password = document.getElementById('password').value;
            const confirmPassword = document.getElementById('confirm_password').value;
            
            if (password !== confirmPassword) {
                e.preventDefault();
                alert('两次输入的密码不一致');
            }
        });
    }
    
    // 添加权限表单验证
    const addPermissionForm = document.getElementById('addPermissionForm');
    if (addPermissionForm) {
        addPermissionForm.addEventListener('submit', function(e) {
            // 如果选中的是管理员用户，阻止提交
            if (selectedUserRole === 'admin') {
                e.preventDefault();
                return;
            }
            
            const canView = document.getElementById('can_view').checked;
            const canAdd = document.getElementById('can_add').checked;
            const canEdit = document.getElementById('can_edit').checked;
            const canDelete = document.getElementById('can_delete').checked;
            
            if (!canView && !canAdd && !canEdit && !canDelete) {
                e.preventDefault();
                alert('请至少选择一个权限');
            }
        });
    }
    
    // 编辑权限表单验证
    const editPermissionForm = document.getElementById('editPermissionForm');
    if (editPermissionForm) {
        editPermissionForm.addEventListener('submit', function(e) {
            const canView = document.getElementById('edit_can_view').checked;
            const canAdd = document.getElementById('edit_can_add').checked;
            const canEdit = document.getElementById('edit_can_edit').checked;
            const canDelete = document.getElementById('edit_can_delete').checked;
            
            if (!canView && !canAdd && !canEdit && !canDelete) {
                e.preventDefault();
                alert('请至少选择一个权限');
            }
        });
    }
    
    // 编辑用户按钮点击事件
    document.querySelectorAll('.edit-user-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            // 从按钮的data-user-id属性中获取用户ID
            const userId = this.getAttribute('data-user-id');
            console.log("编辑用户, ID:", userId);
            
            // 查找编辑表单并修改其action
            const editForm = document.getElementById('editUserForm');
            if (editForm) {
                // 构建完整的URL，确保ID被正确替换
                const baseAction = '/admin/edit_user/';
                editForm.action = baseAction + userId;
                console.log("表单action已更新为:", editForm.action);
            } else {
                console.error("无法找到编辑用户表单");
            }
            
            const username = this.getAttribute('data-username');
            const email = this.getAttribute('data-email');
            const role = this.getAttribute('data-role');
            const isActive = this.getAttribute('data-active') === 'True';
            
            document.getElementById('edit_user_id').value = userId;
            document.getElementById('edit_username').value = username;
            document.getElementById('edit_email').value = email;
            document.getElementById('edit_role').value = role;
            document.getElementById('edit_is_active').checked = isActive;
        });
    });
    
    // 重置密码按钮点击事件
    document.querySelectorAll('.reset-pwd-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            const username = this.getAttribute('data-username');
            
            document.getElementById('reset_user_id').value = userId;
            document.getElementById('reset_username').textContent = username;
        });
    });
    
    // 切换状态按钮点击事件
    document.querySelectorAll('.toggle-status-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const userId = this.getAttribute('data-user-id');
            const username = this.getAttribute('data-username');
            const isActive = this.getAttribute('data-active') === 'True';
            
            document.getElementById('toggle_user_id').value = userId;
            
            // 更新提示消息文字
            const messageElement = document.getElementById('toggle-status-message');
            if (isActive) {
                messageElement.innerHTML = `确定要<strong class="text-danger">禁用</strong>用户 <strong>${username}</strong> 吗？`;
                document.getElementById('toggleUserStatusButton').textContent = '确认禁用';
            } else {
                messageElement.innerHTML = `确定要<strong class="text-success">启用</strong>用户 <strong>${username}</strong> 吗？`;
                document.getElementById('toggleUserStatusButton').textContent = '确认启用';
            }
        });
    });
    
    // 重置密码表单验证
    const resetPwdForm = document.getElementById('resetPasswordForm');
    if (resetPwdForm) {
        resetPwdForm.addEventListener('submit', function(e) {
            const newPassword = document.getElementById('new_password').value;
            const confirmNewPassword = document.getElementById('confirm_new_password').value;
            
            if (newPassword !== confirmNewPassword) {
                e.preventDefault();
                alert('两次输入的密码不一致');
            }
        });
    }
    
    // 权限逻辑：添加到文档加载完成事件中
    function setupPermissionLogic(formId) {
        const form = document.getElementById(formId);
        if (!form) return;
        
        const canViewCheckbox = form.querySelector('[name="can_view"]');
        const otherPermissions = [
            form.querySelector('[name="can_add"]'),
            form.querySelector('[name="can_edit"]'),
            form.querySelector('[name="can_delete"]')
        ];
        
        // 确保所有元素都存在
        if (!canViewCheckbox || otherPermissions.some(el => !el)) return;
        
        // 当其他权限被勾选时，自动勾选"可查看"权限
        otherPermissions.forEach(checkbox => {
            checkbox.addEventListener('change', function() {
                if (this.checked) {
                    canViewCheckbox.checked = true;
                    canViewCheckbox.disabled = true; // 禁用可查看复选框，防止取消
                } else {
                    // 检查是否还有其他权限被勾选
                    const anyOtherChecked = otherPermissions.some(cb => cb.checked);
                    canViewCheckbox.disabled = anyOtherChecked;
                }
            });
        });
        
        // 初始检查状态
        function updateViewCheckboxState() {
            const anyOtherChecked = otherPermissions.some(cb => cb.checked);
            if (anyOtherChecked) {
                canViewCheckbox.checked = true;
                canViewCheckbox.disabled = true;
            } else {
                canViewCheckbox.disabled = false;
            }
        }
        
        // 页面加载和模态框打开时检查状态
        updateViewCheckboxState();
        
        // 添加模态框事件监听
        const modalId = formId === 'addPermissionForm' ? 'addPermissionModal' : 'editPermissionModal';
        const modal = document.getElementById(modalId);
        if (modal) {
            modal.addEventListener('show.bs.modal', updateViewCheckboxState);
        }
    }
    
    // 设置添加权限表单的逻辑
    setupPermissionLogic('addPermissionForm');
    
    // 设置编辑权限表单的逻辑
    setupPermissionLogic('editPermissionForm');
    
    // 获取操作类型和区域选择下拉菜单元素
    const operationTypeSelect = document.getElementById('operation_type');
    const areaIdSelect = document.getElementById('area_id');
    const areaNameInput = document.getElementById('area_name'); // 隐藏的区域名称输入框，用于提交
    
    // 当操作类型改变时更新区域列表
    if (operationTypeSelect && areaIdSelect) {
        operationTypeSelect.addEventListener('change', function() {
            const operationType = this.value;
            if (!operationType) {
                // 如果没有选择操作类型，清空并禁用区域选择
                areaIdSelect.innerHTML = '<option value="">-- 请选择区域 --</option>';
                areaIdSelect.disabled = true;
                return;
            }
            
            // 显示加载中提示
            areaIdSelect.innerHTML = '<option value="">加载中...</option>';
            areaIdSelect.disabled = true;
            
            // 发送AJAX请求获取对应的区域列表
            fetch(`/admin/get_areas/${encodeURIComponent(operationType)}`)
                .then(response => response.json())
                .then(data => {
                    // 清空当前选项
                    areaIdSelect.innerHTML = '';
                    
                    if (data.success) {
                        // 如果该操作类型不可用
                        if (!data.available) {
                            const option = document.createElement('option');
                            option.value = '';
                            option.textContent = data.message || '暂不可用';
                            areaIdSelect.appendChild(option);
                            areaIdSelect.disabled = true;
                            
                            // 显示提示信息
                            const alertDiv = document.createElement('div');
                            alertDiv.className = 'alert alert-warning mt-2';
                            alertDiv.textContent = data.message || '该功能暂不可用';
                            areaIdSelect.parentNode.appendChild(alertDiv);
                            
                            setTimeout(() => {
                                alertDiv.remove();
                            }, 5000); // 5秒后移除提示
                            
                            return;
                        }
                        
                        // 添加默认选项
                        const defaultOption = document.createElement('option');
                        defaultOption.value = '';
                        defaultOption.textContent = '-- 请选择区域 --';
                        areaIdSelect.appendChild(defaultOption);
                        
                        // 添加从服务器获取的区域列表
                        data.areas.forEach(area => {
                            const option = document.createElement('option');
                            option.value = area.id;
                            option.textContent = area.name;
                            option.setAttribute('data-area-name', area.name); // 存储区域名称
                            areaIdSelect.appendChild(option);
                        });
                        
                        // 启用区域选择
                        areaIdSelect.disabled = false;
                    } else {
                        // 显示错误信息
                        const option = document.createElement('option');
                        option.value = '';
                        option.textContent = '加载失败，请重试';
                        areaIdSelect.appendChild(option);
                    }
                })
                .catch(error => {
                    console.error('获取区域列表失败:', error);
                    areaIdSelect.innerHTML = '<option value="">加载失败，请重试</option>';
                });
        });
        
        // 当区域选择改变时，更新隐藏的区域名称字段
        areaIdSelect.addEventListener('change', function() {
            if (areaNameInput) {
                const selectedOption = this.options[this.selectedIndex];
                if (selectedOption && selectedOption.getAttribute('data-area-name')) {
                    areaNameInput.value = selectedOption.getAttribute('data-area-name');
                } else {
                    areaNameInput.value = '';
                }
            }
        });
    }
    
    // 这里将编辑权限按钮点击事件移动到DOMContentLoaded事件内部
    // 而不是保留为一个单独的全局事件处理器
    function setupEditPermissionButtons() {
        document.querySelectorAll('.edit-permission-btn').forEach(btn => {
            btn.addEventListener('click', function() {
                const permissionId = this.getAttribute('data-permission-id');
                const operationType = this.getAttribute('data-operation-type');
                const areaId = this.getAttribute('data-area-id');
                const areaName = this.getAttribute('data-area-name');
                const canView = this.getAttribute('data-can-view') === 'true';
                const canAdd = this.getAttribute('data-can-add') === 'true';
                const canEdit = this.getAttribute('data-can-edit') === 'true';
                const canDelete = this.getAttribute('data-can-delete') === 'true';
                
                // 设置表单值
                const form = document.getElementById('editPermissionForm');
                form.action = `/admin/edit_permission/${permissionId}`;
                
                // 设置隐藏字段的值
                document.getElementById('edit_permission_operation_type').value = operationType;
                document.getElementById('edit_permission_area_id').value = areaId;
                document.getElementById('edit_permission_area_name').value = areaName;
                
                document.getElementById('edit_operation_type').value = operationType;
                document.getElementById('edit_area_id').value = areaId;
                document.getElementById('edit_can_view').checked = canView;
                document.getElementById('edit_can_add').checked = canAdd;
                document.getElementById('edit_can_edit').checked = canEdit;
                document.getElementById('edit_can_delete').checked = canDelete;
                
                // 显示编辑模态框
                const modal = new bootstrap.Modal(document.getElementById('editPermissionModal'));
                modal.show();
            });
        });
    }
    
    // 调用函数以设置编辑按钮事件处理
    setupEditPermissionButtons();
    
    // 在renderPermissions函数中也需要调用这个函数
    // 确保动态加载的权限卡片上的编辑按钮也能正常工作
    const originalRenderPermissions = renderPermissions;
    renderPermissions = function(permissions) {
        originalRenderPermissions(permissions);
        setupEditPermissionButtons();
    };
});

// 移除之前添加的模态框监听器，避免冲突
// $('#editUserModal').on('show.bs.modal', function(event) { ... });
</script>
{% endblock %}